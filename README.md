# DSR路由协议

## 特点
DSR是一种典型的按需（on-demand）Ad Hoc路由协议，同时DSR使用源路由即每个分组头部显式地包含了从源节点到达目的节点的完整节点序列，使用源路由的任何中间节点都无需进行复杂的路由操作而只需根据分组头部的路由信息将分组转发到下一个节点即可。

## 组成
DSR协议主要由两部分构成即路由发现和路由维护。路由发现和路由维护协同工作保证了节点维持的到达目的节点的路由的及时和有效性:
    
**路由发现：** 当源节点S要发送一个数据分组到目的节点D，但是源节点并不知道到达目的节点的路由信息时，源节点就会发起一次路由发现过程。为了建立一条路由，源节点广播一个 **路由请求(Route Request)分组**，当该请求分组到达目的节点，或者是到达某个中间节点且该节点具有到达目标节点的路由信息时，这些节点就向源节点发送一个包含着S到D的完整路由信息的 **路由应答(Route Reply)分组**，源节点S就会根据这些信息建立新的路由。

**路由维护：** 由于网络中各节点的移动性，网络拓扑随时会发生变化，一条路径中的某两个节点可能会因距离超出双方的传输半径或其它的原因诸如中间节点故障等而导致现存路由信息的失效。当路由维护指明某个源路由失效时，就使用路由错误(ROUTE ERROR)通知源节点S，源节点S就会尝试使用其它可以到达目的节点D的路由路径，或者再一次发起路由发
现过程来寻找一条新的路由路径。这个过程被称为路由维护。

**路由缓存：** 一个使用DSR参与Ad Hoc网络的结点所需的所有路由信息都存储在路由缓存中。网络中的每个节点维护自己的路由缓存。当一个结点听到Ad Hoc网络中结点之间的新链路时会将该信息添加进缓存中；同样的，当一个结点得知现存路由息失效时，将会从缓存中删除该息，如果路山缓存溢出，需要采用LRU（Least Recently Used）算法来进行淘汰处理

**发送缓冲区：** 结点的发送缓冲区是一些由于该结点没有一个到达目的节点的源路径而不能被该结点发送的分组组成的队列。一般来讲，节点在将分组插入发送缓冲区的同时就会发起一个路由发现过程，如果路由发现过程成功的话，这些分组就会被发送出去。在发送缓冲区中的每个分组都标记了它进入发送缓冲区的时间，当在被放入SEND_BUFFER_TIMEOUT秒后，它将被丢弃。如果必须的话，可以采用FIFO策略将分组在没有超时时将其丢弃以防止发送缓冲区的溢出。

**路由请求表：** 如果某节点发送或转发了发往某目的结点的路由请求分组，则在接下来的DSR_REQ——TIMEOUT时间间隔内，该节点将不允许再次向这个目的结点发送路由请求分组。节点的路由请求表是最近该结点发出的或转发的路由请求分组的的集合，其中每个条目都记录了其被插入路由请求表的时间，当超时后这些条目将会被删除，如果路由请求表溢出，需要采用LRU算法来进行淘汰处理。

**重传缓冲区：** DSR路由维护的基础就是每个节点需要在发出或者转发分组时保证分组能够顺利地被下跳的节点所接
收:如果不能确认下跳已经成功接收到分组，该节点需要作出相应的反应，如重传或者到达最大重传次数 MAX_RETRANSIMTE_TIMES 后丢弃该分组，同时，向源节点发送路由错误分组。重传缓冲区是节点发送或转发的分组中那些尚未得到下一跳确认的分组的集合。

## DSR 分组结构
DSR协议使用一个结构特殊的DSR头来携带控制信息，这个DSR头可以被任何己经存在的IP分组携带。DSR头的开始部分是一个固定尺寸的结构体，其后跟随若干个携带DSR选项信息的DSR选项结构体。整个DSR头的结束由包含在开始部分固定结构体中的头部长度来控制。DSR头应该被插入到现存IP分组的IP头和仟何的传输层协议头之间。DSR分组结构如图所示：

|应用层|
|传输层|
|网络层（DSR）|
|数据链路层|
|物理层|

|IP头|DSR头|DSR选项|传输层数据|

